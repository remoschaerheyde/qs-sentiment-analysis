!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.halyard=t()}(this,function(){"use strict";function e(e){return e.replace(/"/g,'""')}function t(e){return["time","timestamp","date","interval"].indexOf((e=e||"").toLowerCase())>-1}function n(e){return e.name||e.src}class i{constructor(e,t){this.path=e,this.connectionType=t,this.fileExtension=""}getFileExtension(){return this.fileExtension}getConnectionType(){return this.connectionType}getQixConnectionObject(){return{qName:this.getName(),qConnectionString:this.path,qType:this.getConnectionType()}}getName(){return this.name||(this.name="xxxxx-8xxxx-yxxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),this.name}getLibStatement(){return`lib://${this.getName()}`}getScript(){return`FROM [${this.getLibStatement()}]`}}var a={File:class extends i{constructor(e){super(function(e){let t=e.match(/^(.*)(\\.*\..*$|\\.*)$/);return t?t[1]:(t=e.match(/^(.*)(\/.*\..*$|\/.*)$/))&&t[1]}(e),"folder"),this.fileName=function(e){let t=e.match(/^.*\\(.*\..*|.*)$/);return t?t[1]:(t=e.match(/^.*\/(.*\..*|.*)$/))&&t[1]}(e),this.fileExtension=function(e){const t=e.match(/^.*\.(.*)$/);return t&&t[1]}(e)||"txt"}getLibStatement(){return`${super.getLibStatement()}/${this.fileName}`}},Web:class extends i{constructor(e,t){super(e,"internet");const n=e.match(/^https?:\/\/.*\/.*\.(\w*)\?.*$/)||e.match(/^https?:\/\/.*\/.*\.(\w*)$/);this.fileExtension=t||n&&n[1]||"html"}},Inline:class extends i{constructor(e){super(),this.data=e,this.fileExtension="txt"}getScript(){return`INLINE "\n${e(this.data)}\n"`}getLibStatement(){}getQixConnectionObject(){}}};function r(e,t){return e&&"string"==typeof e&&(e.indexOf(t)>-1||e.indexOf("\n")>-1)?`"${e.replace(/"/g,'""').replace(/\n/g," ")}"`:e}const s=new class{constructor(){this.connectionsRegistry=[]}addConnection(e,t){this.connectionsRegistry.push({matchingFn:e,connection:t})}findMatch(e){for(let t=0;t<this.connectionsRegistry.length;t+=1)if(this.connectionsRegistry[t].matchingFn(e))return this.connectionsRegistry[t].connection(e);return e}};var o;function u(e){return["utf8","unicode","ansi","oem","mac"].indexOf(e)>-1&&e||"NaN"!==Number(e).toString()&&`codepage is ${e}`}s.addConnection(e=>"string"==typeof e&&e.match(/^https?:\/\/(.*)$/g),e=>new a.Web(e)),s.addConnection(e=>"string"==typeof e&&e.match(/^.*\.(.*)$/g),e=>new a.File(e)),s.addConnection(e=>e instanceof Array&&(e=e,!!(e instanceof Array&&e[0]&&"object"==typeof e[0])),e=>new a.Inline(function(e){e instanceof Array==0&&(e=[e]);let t="";const n=Object.keys(e[0]);t=`${t+n.map(e=>r(e,",")).join(",")}\n`;let i=[];for(let a=0;a<e.length;a+=1){i=[];for(let t=0;t<n.length;t+=1)i.push(r(e[a][n[t]],","));t=`${t+i.join(",")}\n`}return t=t.slice(0,-"\n".length)}(e))),s.addConnection(e=>"string"==typeof e,e=>new a.Inline(e));class c{constructor(e,t){this.connection=s.findMatch(e),"string"==typeof(t=t||{})?(this.name=t,t={}):(this.name=t.name,this.fields=t.fields,this.prefix=t.prefix,t.section&&(this.section=t.section)),this.options=t}getFields(){return this.fields}getFieldList(){return this.fields?this.fields.map(n=>{let i=`"${e(n.src||"")}"`;if(t(n.type)){const e=n.type.toUpperCase();n.inputFormat&&(i=`${e}#(${i}, '${n.inputFormat}')`),i=n.displayFormat?`${e}(${i}, '${n.displayFormat}')`:`${e}(${i})`}if(n.expr&&(i=n.expr),!n.name&&!n.src)throw new Error(`A name or src needs to specified on the field: ${JSON.stringify(n)}`);return`${"  "+i} AS "${e(n.name||n.src)}"`}).join(",\n"):"*"}isProceedingLoad(){return this.connection instanceof c}getPrefix(){return this.prefix?`${this.prefix}\n`:""}getScript(){return this.isProceedingLoad()?`${this.getPrefix()}LOAD\n${this.getFieldList()};\n${this.connection.getScript()}`:(this.connection.getFileExtension&&(this.options.fileExtension=this.connection.getFileExtension()),`${this.getPrefix()}LOAD\n${this.getFieldList()}\n${this.connection.getScript()}${function(t){t||(t={});const n=[];if(t.fileExtension){let e=t.fileExtension;"xlsx"===e&&(e="ooxml"),"csv"===e&&(e="txt"),"htm"===e&&(e="html"),n.push(e)}(t.headerRowNr||0===t.headerRowNr)&&(n.push(`header is ${t.headerRowNr} lines`),n.push("embedded labels")),t.delimiter&&n.push(`delimiter is '${t.delimiter}'`),t.characterSet&&u(t.characterSet)&&n.push(u(t.characterSet)),t.srcTable&&n.push(`table is "${e(t.srcTable)}"`),t.noLabels&&n.push("no labels");let i="";return n.length>0&&(i=`\n(${n.join(", ")})`),i}(this.options)};`)}getName(){return this.name||""}getSection(){return this.section}getConnection(){return this.connection}}var h={qTypes:{timestamp:"TS",date:"D",time:"T",interval:"IV"},qDimensionType:{timestamp:"T",text:"D",numeric:"N"}};const m=",";function l(e){return function(e){return e.qDimensionType===h.qDimensionType.text}(e)?"text":function(e){return e.qDimensionType===h.qDimensionType.numeric&&0===e.qTags.length}(e)?"mixed":function(e){return e.qDimensionType===h.qDimensionType.timestamp||e.qDimensionType===h.qDimensionType.numeric&&e.qNumFormat.qType===h.qTypes.timestamp}(e)?"timestamp":function(e){return e.qDimensionType===h.qDimensionType.numeric&&e.qNumFormat.qType===h.qTypes.time}(e)?"time":function(e){return e.qDimensionType===h.qDimensionType.numeric&&e.qNumFormat.qType===h.qTypes.date}(e)?"date":function(e){return e.qDimensionType===h.qDimensionType.numeric&&e.qNumFormat.qType===h.qTypes.interval}(e)?"interval":"num"}function d(e,t){return e.indexOf(t)>-1||e.indexOf("\n")>-1?`'${e.replace(/'/g,"''").replace(/\n/g," ")}'`:e}function p(e,t){return function(e){return"measure"===e.type||"dimension"===e.type&&(t=e.dimensionType,["timestamp","interval","time","date","num"].indexOf((t=t||"").toLowerCase())>-1);var t}(t)?function(e){return e.qNum}(e):function(e){return d(e.qText,m)}(e)}class f{constructor(e,t){this.items=[],this.fields=[],this.hyperCubeLayout=this.validateHyperCubeLayout(e),"string"==typeof(t=t||{})?(this.name=t,t={}):(this.name=t.name,t.section&&(this.section=t.section)),this.parseHyperCubeLayout(t),this.options=t}validateHyperCubeLayout(e){if(!e)throw new Error("Hyper cube layout is undefined");if(!e.qDimensionInfo)throw new Error("qDimensionInfo is undefined");if(!e.qMeasureInfo)throw new Error("qMeasureInfo is undefined");if("P"===e.qMode)throw new Error("Cannot add hyper cube in pivot mode, qMode:P(DATA_MODE_PIVOT) is not supported");if("K"===e.qMode)throw new Error("Cannot add hyper cube in stacked mode, qMode:K(DATA_MODE_PIVOT_STACK) is not supported");if("S"===e.qMode)return this.validateDataPages(e.qDataPages),this.validateDataPagesCoverage(e.qDataPages,e),e;throw new Error("HyperCubeLayout is not valid")}validateDataPages(e){if(!e)throw new Error("qDataPages are undefined");if(e[0].qArea&&e[0].qArea.qTop>0)throw new Error("qDataPages first page should start at qTop: 0.")}validateDataPagesCoverage(e,t){let n=0;if(e.forEach(e=>{this.validateQMatrix(e),this.validateQArea(e,t,n),n+=e.qArea.qHeight},this),t.qSize.qcy!==n)throw new Error("qDataPages are missing pages.")}validateQMatrix(e){if(!e.qMatrix)throw new Error("qMatrix of qDataPages are undefined");if(0===e.qMatrix.length)throw new Error("qDataPages are empty")}validateQArea(e,t,n){if(!e.qArea)throw new Error("qArea of qDataPages are undefined");if(e.qArea.qLeft>0)throw new Error("qDataPages have data pages that's not of full qWidth.");if(e.qArea.qWidth<t.qSize.qcx)throw new Error("qDataPages have data pages that's not of full qWidth.");if(e.qArea.qTop<n)throw new Error("qDataPages have overlapping data pages.");if(e.qArea.qTop>n)throw new Error("qDataPages are missing pages.")}parseHyperCubeLayout(){const e=this;e.fields=e.getFieldsFromHyperCubeLayout(),e.data=e.getDataFromHyperCubeLayout();const t=`${e.fields.map(e=>e.name).join(",")}\n${this.data}`;let n=!1;e.fields.forEach(t=>{t.isDual&&(n=!0,e.items.push(e.getMapTableForDualField(t)))});const i={name:e.name,fields:e.getFieldsDefinition(e.fields)};e.section&&!n&&(i.section=e.section),e.items.push(new c(t,i))}getFieldsDefinition(e){return e.map(e=>{const n={name:e.name};return t(e.dimensionType)&&(n.type=e.dimensionType,n.displayFormat=e.displayFormat),e.isDual?n.expr=`Dual(ApplyMap('MapDual__${e.name}', "${e.name}"), "${e.name}")`:n.src=e.name,n})}mapDualFieldQMatrix(e,t){return e.map(e=>(n=e[t.index],`${n.qNum}${m}${d(n.qText,m)}`)).filter(function(e,t,n){return n.indexOf(e)===t});var n}getMapTableForDualField(e){const t=this.hyperCubeLayout.qDataPages.reduce((e,t)=>[...e,...t.qMatrix],[]),n=this.mapDualFieldQMatrix(t,e),i=`${function(e){return`${e.name}${m}${e.name}_qText}`}(e)}\n${n.join("\n")}`,a={name:`MapDual__${e.name}`,prefix:"Mapping"};return this.section&&0===this.items.length&&(a.section=this.section),new c(i,a)}getDataFromHyperCubeLayout(){const e=this;var t;return e.hyperCubeLayout.qDataPages.map(t=>t.qMatrix.map(t=>t.map((t,n)=>{const i=e.fields[n];return!i.isDual&&(t=t,function(e){return"dimension"===e.type&&"num"===e.dimensionType}(i)&&t.qText!==Number(t.qNum).toString())&&(i.isDual=!0),p(t,i)}).join(",")).join("\n")).join("\n")}getFieldsFromHyperCubeLayout(){const e=this,t=[];for(let n=0;n<e.hyperCubeLayout.qDimensionInfo.length;n+=1)t.push({type:"dimension",dimensionType:l(e.hyperCubeLayout.qDimensionInfo[n]),name:e.hyperCubeLayout.qDimensionInfo[n].qFallbackTitle,displayFormat:e.hyperCubeLayout.qDimensionInfo[n].qNumFormat.qFmt,index:n});for(let n=0;n<e.hyperCubeLayout.qMeasureInfo.length;n+=1)t.push({type:"measure",name:e.hyperCubeLayout.qMeasureInfo[n].qFallbackTitle,index:e.hyperCubeLayout.qDimensionInfo.length+n});return t}getItems(){return this.items}}class g{constructor(e){this.defaultSetStatements=e}getScript(){return Object.keys(this.defaultSetStatements).map(e=>`SET ${e}='${Array.isArray(this.defaultSetStatements[e])?this.defaultSetStatements[e].join(";"):this.defaultSetStatements[e]}';`).join("\n")}getName(){return""}}class y{constructor(e){this.getFieldFn=e.fieldMatchFunction,this.name=e.name,this.fieldTag=e.fieldTag,this.derivedFieldDefinition=e.derivedFieldDefinition}getScript(){const e=this.getFieldFn()||[];if(e.length>0)return this.getDefinition(e.map(n))}getDefinition(t){return`"${e(this.name)}":\nDECLARE FIELD DEFINITION Tagged ('$${this.fieldTag}')\nFIELDS\n${this.derivedFieldDefinition}\nDERIVE FIELDS FROM FIELDS [${t.join(", ")}] USING "${e(this.name)}";`}}const $="Dual(Year($1), YearStart($1)) AS [Year] Tagged ('$axis', '$year'),\n  Dual('Q'&Num(Ceil(Num(Month($1))/3)),Num(Ceil(NUM(Month($1))/3),00)) AS [Quarter] Tagged ('$quarter', '$cyclic'),\n  Dual(Year($1)&'-Q'&Num(Ceil(Num(Month($1))/3)),QuarterStart($1)) AS [YearQuarter] Tagged ('$yearquarter', '$qualified'),\n  Dual('Q'&Num(Ceil(Num(Month($1))/3)),QuarterStart($1)) AS [_YearQuarter] Tagged ('$yearquarter', '$hidden', '$simplified'),\n  Month($1) AS [Month] Tagged ('$month', '$cyclic'),\n  Dual(Year($1)&'-'&Month($1), monthstart($1)) AS [YearMonth] Tagged ('$axis', '$yearmonth', '$qualified'),\n  Dual(Month($1), monthstart($1)) AS [_YearMonth] Tagged ('$axis', '$yearmonth', '$simplified', '$hidden'),\n  Dual('W'&Num(Week($1),00), Num(Week($1),00)) AS [Week] Tagged ('$weeknumber', '$cyclic'),\n  Date(Floor($1)) AS [Date] Tagged ('$axis', '$date', '$qualified'),\n  Date(Floor($1), 'D') AS [_Date] Tagged ('$axis', '$date', '$hidden', '$simplified'),\n  If (DayNumberOfYear($1) <= DayNumberOfYear(Today()), 1, 0) AS [InYTD] ,\nYear(Today())-Year($1) AS [YearsAgo] ,\n  If (DayNumberOfQuarter($1) <= DayNumberOfQuarter(Today()),1,0) AS [InQTD] ,\n4*Year(Today())+Ceil(Month(Today())/3)-4*Year($1)-Ceil(Month($1)/3) AS [QuartersAgo] ,\nCeil(Month(Today())/3)-Ceil(Month($1)/3) AS [QuarterRelNo] ,\n  If(Day($1)<=Day(Today()),1,0) AS [InMTD] ,\n12*Year(Today())+Month(Today())-12*Year($1)-Month($1) AS [MonthsAgo] ,\nMonth(Today())-Month($1) AS [MonthRelNo] ,\n  If(WeekDay($1)<=WeekDay(Today()),1,0) AS [InWTD] ,\n(WeekStart(Today())-WeekStart($1))/7 AS [WeeksAgo] ,\nWeek(Today())-Week($1) AS [WeekRelNo];";const q="\n\n";class x{constructor(){var e;this.defaultSetStatements={},this.items=[],this.addItem(new g(this.defaultSetStatements)),this.lastItems=[(e=(e=>this.getFields(e)),new y({name:"autoCalendar",fieldTag:"date",derivedFieldDefinition:$,fieldMatchFunction:()=>e(e=>e.calendarTemplate)}))]}getConnections(){return this.items.filter(e=>e.getConnection).map(e=>e.getConnection())}getQixConnections(){return this.getConnections().map(e=>e.getQixConnectionObject()).filter(e=>e)}getFields(e){e=e||(()=>!0);const t=[];return this.items.forEach(n=>{n.getFields&&n.getFields()&&t.push(...n.getFields().filter(e))}),t}setDefaultSetStatements(e,t){const n=this;Object.keys(e).forEach(i=>{t&&n.defaultSetStatements[i]||(n.defaultSetStatements[i]=e[i])})}getItemScript(t){let n=t.getScript();return t.getName&&t.getName()&&(n=t.section?`///$tab ${e(t.section)}\n"${e(t.getName())}":\n${n}`:`"${e(t.getName())}":\n${n}`),n}getAllScriptBlocks(){return this.items.concat(this.lastItems).filter(e=>e.getScript())}getScript(){return this.getAllScriptBlocks().map(e=>this.getItemScript(e)).join(q)}addHyperCube(e,t){let n;n=e instanceof f?e:new f(e,t);for(let e=0;e<n.items.length;e+=1)this.checkIfItemNameExists(n.items[e]);for(let e=0;e<n.items.length;e+=1)this.addItem(n.items[e]);return n}addTable(e,t){let n;return n=e instanceof c?e:new c(e,t),this.addItem(n)}checkIfItemNameExists(e){if(e.getName&&e.getName()&&this.items.filter(t=>t.getName()===e.getName()).length>0)throw new Error("Cannot add another table with the same name.")}addItem(e){return this.checkIfItemNameExists(e),this.items.push(e),e}getItemThatGeneratedScriptAt(e){const t=this.getAllScriptBlocks();let n=0;for(let i=0;i<t.length;i+=1){const a=n+`${this.getItemScript(t[i])}${q}`.length;if(n<=e&&e<=a)return t[i];n=a}}}return x.Table=c,x.HyperCube=f,x.Connections=a,"undefined"!=typeof module&&(module.exports=x),x});
//# sourceMappingURL=halyard.min.js.map
